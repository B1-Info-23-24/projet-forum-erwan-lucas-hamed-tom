{{ define "createpost" }}
<div id="popup-createpost">
    <div id="popup-overlay">
        <div class="popup-content">
            <a href="javascript:void(0)" onclick="togglePopupCreatePost()" class="popup-exit">
                <img src="../static/img/icon/x.png" class="img--icon-x">
            </a>
            <div class="createpost-container">
                <div class="createpost-form">
                    <h2 class="createpost-title">Create a New Post</h2>
                    <form id="createpost-form" enctype="multipart/form-data">
                        <div class="createpost-input">
                            <input type="hidden" id="user_id" name="user_id" value="1"> <!-- Assuming user_id is 1 for example -->
                        </div>
                        <div class="createpost-input">
                            <input type="text" id="theme" name="theme" placeholder="Theme" required>
                        </div>
                        <div class="createpost-input">
                            <textarea id="content" name="content" placeholder="Content" required></textarea>
                        </div>
                        <div class="createpost-input">
                            <input type="file" id="images" name="images" multiple>
                        </div>
                        <button class="createpost-button" type="submit">Create Post</button>
                    </form>
                    <div id="message"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.getElementById('createpost-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const formData = new FormData();
        formData.append('user_id', document.getElementById('user_id').value);
        formData.append('theme', document.getElementById('theme').value);
        formData.append('content', document.getElementById('content').value);
        
        const files = document.getElementById('images').files;
        for (let i = 0; i < files.length; i++) {
            formData.append('images', files[i]);
        }

        const messageDiv = document.getElementById('message');
        try {
            const response = await fetch('http://localhost:8081/api/post/create', {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });
            const result = await response.json();
            if (response.ok) {
                messageDiv.textContent = 'Post created successfully!';
            } else {
                messageDiv.textContent = `Error: ${result.error}`;
            }
        } catch (error) {
            messageDiv.textContent = `Error: ${error.message}`;
        }
    });
       

    const themeButton = document.getElementById('theme-button');
    const themeInput = document.getElementById('theme');

    themeButton.addEventListener('click', () => {
        if (themeButton.classList.contains('Bivouac')) {
            themeButton.classList.remove('Bivouac');
            themeButton.classList.add('Alpinisme');
            themeButton.textContent = 'Alpinisme';
            themeInput.value = 'Alpinisme';
        } else if (themeButton.classList.contains('Alpinisme')) {
            themeButton.classList.remove('Alpinisme');
            themeButton.classList.add('Treck');
            themeButton.textContent = 'Treck';
            themeInput.value = 'Treck';
        } else if (themeButton.classList.contains('Treck')) {
            themeButton.classList.remove('Treck');
            themeButton.classList.add('Randonné');
            themeButton.textContent = 'Randonné';
            themeInput.value = 'Randonné';
        } else {
            themeButton.classList.remove('Randonné');
            themeButton.classList.add('Bivouac');
            themeButton.textContent = 'Bivouac';
            themeInput.value = 'Bivouac';
        }
    });

    let files = [];

    function togglePopupPost() {
        let popup = document.querySelector("#post-overlay")
        popup.classList.toggle("open")
        document.body.classList.toggle('no-scroll');
    }

    document.getElementById("content").addEventListener("input", function() {
        var count = this.value.length;
        document.getElementById("nb-word").innerHTML = `<span>${count}</span>/280`;
    });

    const imageInput = document.getElementById('images');
    const imagePreview = document.getElementById('image-preview');
    const imageInputLabel = document.querySelector('.image-input-label');

    imageInput.addEventListener('change', function() {
        const newFiles = Array.prototype.slice.call(imageInput.files);
        files = files.concat(newFiles);
        imageInput.value = ''; // reset input value to allow re-selecting same files
        displayPreview();
    });

    imagePreview.addEventListener('click', function(event) {
        if (event.target.classList.contains('image-preview-item')) {
            event.target.remove();
            const index = files.findIndex(file => file.name === event.target.alt);
            if (index > -1) {
                files.splice(index, 1);
            }
        }
    });

    function displayPreview() {
        imagePreview.innerHTML = '';
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const imageData = event.target.result;
                const imageHTML = `<img src="${imageData}" alt="${file.name}" class="image-preview-item">`;
                imagePreview.innerHTML += imageHTML;
            };
            reader.readAsDataURL(file);
        });
    }
</script>
{{ end }}
