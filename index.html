<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../static/style.css">
    <link rel="stylesheet" href="../static/popup.css">
    <link rel="stylesheet" href="../static/login.css">
    <link rel="stylesheet" href="../static/signup.css">
    <link rel="stylesheet" href="../static/post.css">
    <title>Forun</title>
</head>
<body>
    {{ template "header" . }}
    <div class="container">
        {{ template "menu" . }}
    
        <div class="right-container">
            <div class="section-img">
                <img src="..//static/img/bivouac.png" class="img--section">
            </div>
            <div id="posts-container" class="posts-container">
            </div>
        </div>
    </div>
    <script>
    async function displayPosts() {
        try {
            const response = await fetch(`http://localhost:8081/api/post/display`, {
                method: 'POST',
                credentials: 'include'
            });
            if (!response.ok) {
                throw new Error(`Error: ${response.statusText}`);
            }
            const posts = await response.json();
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = '';  // Clear existing content
            
            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'post';
                postElement.innerHTML = `
                <div class="post-header">
                    <button class="post-modif"><img src="../static/img/icon/3points.png" class="icon-post-3points"></button> 
                    <div class="post-pointMap-theme">
                        <button class="post-theme" >${post.Theme}</button> 
                        <button class="post-pointMap">View on map<img src="../static/img/icon/ping.png" class="icon-post-pointMap"></button>
                    </div>   
                    <div class="post-user-date-picture">
                        <img src="../static/img/character.png" class="post-picture">
                        <div class="post-user-date">
                            <p class="post-username">${post.Username}</p>
                            <small class="post-date">${new Date(post.CreatedAt).toLocaleString()}</small>
                        </div>
                    </div>
                    <p class="post-print-content">${post.Content}</p>
                    <div class="post-images">
                        ${(post.Images || []).map(image => `<img src="${image.url}" alt="Post Image">`).join('')}
                    </div>
                    <div class="post-interaction">
                        <button class="post-button-like" onclick="likePost(${post.ID}, this)"><img src="../static/img/icon/like.png" class="icon-post-like"></button>
                        <button class="post-button-dislike" onclick="dislikePost(${post.ID}, this)"><img src="../static/img/icon/dislike.png" class="icon-post-dislike"></button>
                        <span id="likes-${post.ID}">${post.Likes || 0} Likes</span>
                        <span id="dislikes-${post.ID}">${post.Dislikes || 0} Dislikes</span>
                    </div>
                </div>
                `;
                postsContainer.appendChild(postElement);
            });
        } catch (error) {
            console.error('Failed to fetch posts:', error);
        }
    }

    async function likePost(postID, button) {
        try {
            const response = await fetch(`http://localhost:8081/api/post/like`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postID })
            });
            if (response.ok) {
                updateLikeDislikeCount(postID);
                button.disabled = true;
                button.nextElementSibling.disabled = true;  // Disable dislike button
            } else {
                const error = await response.json();
                console.error('Error liking post:', error);
            }
        } catch (error) {
            console.error('Error liking post:', error);
        }
    }

    async function dislikePost(postID, button) {
        try {
            const response = await fetch(`http://localhost:8081/api/post/dislike`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postID })
            });
            if (response.ok) {
                updateLikeDislikeCount(postID);
                button.disabled = true;
                button.previousElementSibling.disabled = true;  // Disable like button
            } else {
                const error = await response.json();
                console.error('Error disliking post:', error);
            }
        } catch (error) {
            console.error('Error disliking post:', error);
        }
    }

    async function updateLikeDislikeCount(postID) {
        try {
            const response = await fetch(`http://localhost:8081/api/post/${postID}/likes-dislikes`);
            if (response.ok) {
                const counts = await response.json();
                document.getElementById(`likes-${postID}`).textContent = `${counts.likes} Likes`;
                document.getElementById(`dislikes-${postID}`).textContent = `${counts.dislikes} Dislikes`;
            } else {
                const error = await response.json();
                console.error('Error fetching like/dislike counts:', error);
            }
        } catch (error) {
            console.error('Error fetching like/dislike counts:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', displayPosts);
    </script>
</body>
</html>
